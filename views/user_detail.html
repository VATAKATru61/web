{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.tg_id }} | FAST VPN{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/users.css">
<link rel="stylesheet" href="/static/css/user_detail.css">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
    <p class="page-subtitle">ID: {{ user.tg_id }}</p>
</div>
{% endblock %}

{% block content %}
<div class="user-profile-flex">
    <div class="user-info-card">
        <h2>{{ user.first_name or "–ë–µ–∑ –∏–º–µ–Ω–∏" }}
            {% if user.last_name %} {{ user.last_name }}{% endif %}
        </h2>
        <p><b>Telegram ID:</b> {{ user.tg_id }}</p>
        <p><b>Username:</b> @{{ user.username or "‚Äî" }}</p>
        <p><b>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</b> {{ user.created_at or "‚Äî" }}</p>
        <p><b>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</b> {{ user.last_active or "‚Äî" }}</p>
        <div class="user-actions">
            <a href="/users" class="btn btn-sm btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        </div>
    </div>
    <div class="user-mini-cards-grid">
        <div class="user-mini-card">
            <div class="mini-title">üîë –ü–æ–¥–ø–∏—Å–æ–∫</div>
            <div class="mini-value">{{ subscriptions|length }}</div>
            <div class="mini-last">
                <span><b>Trial:</b> {{ user.trial }}</span>
            </div>
            {% if subscriptions and subscriptions|length > 0 %}
            <div class="mini-last">
                –ü–æ—Å–ª–µ–¥–Ω—è—è:
                <span title="{{ subscriptions[-1].expiry_time }}">
                    {{ subscriptions[-1].key[:6] ~ '...' if subscriptions[-1].key else '' }}
                </span>
                                    <a href="#subs-table" class="btn-view" title="–ö –ø–æ–¥–ø–∏—Å–∫–∞–º">
                        <i class="fas fa-arrow-right"></i>
                        –ü–µ—Ä–µ–π—Ç–∏
                    </a>
            </div>
            {% endif %}
        </div>
        <div class="user-mini-card">
            <div class="mini-title">üéÅ –ü–æ–¥–∞—Ä–∫–æ–≤</div>
            <div class="mini-value">{{ gifts|length }}</div>
            {% if gifts and gifts|length > 0 %}
            <div class="mini-last">
                –ü–æ—Å–ª–µ–¥–Ω–∏–π:
                <span title="{{ gifts[-1].created_at }}">{{ gifts[-1].gift_id }}</span>
                                    <a href="#gifts-table" class="btn-view" title="–ö –ø–æ–¥–∞—Ä–∫–∞–º">
                        <i class="fas fa-arrow-right"></i>
                        –ü–µ—Ä–µ–π—Ç–∏
                    </a>
            </div>
            {% endif %}
        </div>
        <div class="user-mini-card">
            <div class="mini-title">üí≥ –ü–ª–∞—Ç–µ–∂–µ–π</div>
            <div class="mini-value">{{ payments|length }}</div>
            {% if payments and payments|length > 0 %}
            <div class="mini-last">
                –ü–æ—Å–ª–µ–¥–Ω–∏–π:
                <span title="{{ payments[-1].created_at }}">{{ payments[-1].amount }}‚ÇΩ</span>
                                    <a href="#payments-table" class="btn-view" title="–ö –ø–ª–∞—Ç–µ–∂–∞–º">
                        <i class="fas fa-arrow-right"></i>
                        –ü–µ—Ä–µ–π—Ç–∏
                    </a>
            </div>
            {% endif %}
        </div>
        <div class="user-mini-card">
            <div class="mini-title">üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
            <div class="mini-value">{{ referrals|length }}</div>
            {% if referrals and referrals|length > 0 %}
            <div class="mini-last">
                –ü–æ—Å–ª–µ–¥–Ω–∏–π:
                <span title="{{ referrals[-1].referred_tg_id }}">{{ referrals[-1].referred_tg_id }}</span>
                                    <a href="/users/{{ referrals[-1].referred_tg_id }}" class="btn-view" title="–ö —Ä–µ—Ñ–µ—Ä–∞–ª—É">
                        <i class="fas fa-arrow-right"></i>
                        –ü–µ—Ä–µ–π—Ç–∏
                    </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="user-section">
    <h3>–ü–ª–∞—Ç–µ–∂–∏</h3>
    {% if payments and payments|length > 0 %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr><th>ID</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr>
                    <td>{{ payment.id }}</td>
                    <td>{{ payment.amount }}</td>
                    <td>{{ payment.created_at }}</td>
                    <td>{{ payment.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="empty-text">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>
    {% endif %}
</div>

<div class="user-section">
    <h3>–ü–æ–¥–ø–∏—Å–∫–∏</h3>
    {% if subscriptions and subscriptions|length > 0 %}
    <div class="table-container">
        <table class="data-table" id="subs-table">
            <thead>
                <tr>
                    <th>ID</th><th>Email</th><th>–ö–ª—é—á</th><th>–¢–∞—Ä–∏—Ñ</th>
                    <th>–ù–∞—á–∞–ª–æ</th><th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in subscriptions %}
                <tr>
                    <td>{{ sub.client_id }}</td>
                    <td>{{ sub.email }}</td>
                    <td>{{ sub.key }}</td>
                    <td>{{ sub.tariff_id }}</td>
                    <td>{{ sub.created_at }}</td>
                    <td>{{ sub.expiry_time }}</td>
                    <td>
                        {% if sub.is_frozen %}
                        <span class="status-frozen">–ó–∞–º–æ—Ä–æ–∂–µ–Ω–∞</span>
                        {% else %}
                        <span class="status-active">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="empty-text">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</p>
    {% endif %}
</div>

<div class="user-section">
    <h3>–†–µ—Ñ–µ—Ä–∞–ª—ã</h3>
    {% if referrals and referrals|length > 0 %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>–†–µ—Ñ–µ—Ä–∞–ª (tg_id)</th><th>–ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª</th><th>–ù–∞–≥—Ä–∞–¥–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for ref in referrals %}
                <tr>
                    <td>{{ ref.referred_tg_id }}</td>
                    <td>{{ ref.referrer_tg_id }}</td>
                    <td>
                        {% if ref.reward_issued %}
                        <span class="status-active">–î–∞</span>
                        {% else %}
                        <span class="status-frozen">–ù–µ—Ç</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="empty-text">–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</p>
    {% endif %}
</div>

<div class="user-section">
    <h3>–ü–æ–¥–∞—Ä–∫–∏</h3>
    {% if gifts and gifts|length > 0 %}
    <div class="table-container">
        <table class="data-table" id="gifts-table">
            <thead>
                <tr>
                    <th>ID</th><th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th><th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th><th>–ú–µ—Å—è—Ü—ã</th>
                    <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th><th>–°—Å—ã–ª–∫–∞</th><th>–ò—Å–ø.</th><th>–ë–µ–∑–ª–∏–º–∏—Ç</th>
                    <th>–ú–∞–∫—Å.</th><th>–¢–∞—Ä–∏—Ñ</th><th>–°–æ–∑–¥–∞–Ω</th>
                </tr>
            </thead>
            <tbody>
                {% for gift in gifts %}
                <tr>
                    <td>{{ gift.gift_id }}</td>
                    <td>{{ gift.sender_tg_id }}</td>
                    <td>{{ gift.recipient_tg_id }}</td>
                    <td>{{ gift.selected_months }}</td>
                    <td>{{ gift.expiry_time }}</td>
                    <td>{{ gift.gift_link }}</td>
                    <td>{{ gift.is_used }}</td>
                    <td>{{ gift.is_unlimited }}</td>
                    <td>{{ gift.max_usages }}</td>
                    <td>{{ gift.tariff_id }}</td>
                    <td>{{ gift.created_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="empty-text">–ù–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤</p>
    {% endif %}
</div>

<div id="editUserModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <form id="editUserForm" onsubmit="return submitEditUserForm(event)">
            <input type="hidden" id="edit-tg_id">
            <div class="form-group">
                <label for="edit-first_name">–ò–º—è</label>
                <input type="text" id="edit-first_name" required>
            </div>
            <div class="form-group">
                <label for="edit-username">Username</label>
                <input type="text" id="edit-username">
            </div>
            <div class="form-group">
                <label for="edit-balance">–ë–∞–ª–∞–Ω—Å</label>
                <input type="number" id="edit-balance" step="0.01">
            </div>
            <div class="form-group">
                <label for="edit-trial">Trial</label>
                <input type="checkbox" id="edit-trial">
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const ADMIN_TG_ID = "{{ admin_tg_id }}";
  const TOKEN       = "{{ token }}";

  function openEditModal(user) {
    document.getElementById('edit-tg_id').value      = user.tg_id;
    document.getElementById('edit-first_name').value = user.first_name || '';
    document.getElementById('edit-username').value   = user.username   || '';
    document.getElementById('edit-balance').value    = user.balance    || 0;
    document.getElementById('edit-trial').checked    = user.trial      || false;
    document.getElementById('editUserModal').style.display = 'block';
  }

  function closeEditModal() {
    document.getElementById('editUserModal').style.display = 'none';
  }

  async function submitEditUserForm(event) {
    event.preventDefault();
    const tg_id = document.getElementById('edit-tg_id').value;
    const payload = {
      first_name: document.getElementById('edit-first_name').value,
      username:   document.getElementById('edit-username').value,
      balance:    parseFloat(document.getElementById('edit-balance').value),
      trial:      document.getElementById('edit-trial').checked
    };

    const res = await fetch(
      `/users/${encodeURIComponent(tg_id)}?tg_id=${ADMIN_TG_ID}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-Token': TOKEN
        },
        body: JSON.stringify(payload)
      }
    );

    if (res.ok) {
      location.reload();
    } else {
      const err = await res.json().catch(()=>({}));
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (err.detail||res.status));
    }
  }

  function openDeleteModal(tg_id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
    deleteUser(tg_id);
  }

  async function deleteUser(tg_id) {
    const res = await fetch(
      `/users/${encodeURIComponent(tg_id)}?tg_id=${ADMIN_TG_ID}`, {
        method: 'DELETE',
        headers: { 'X-Token': TOKEN }
      }
    );
    if (res.ok) window.location.href = '/users';
    else {
      const err = await res.json().catch(()=>({}));
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (err.detail||res.status));
    }
  }

  async function deleteReferral(referred_tg_id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞?')) return;

    const referrer_tg_id = "{{ user.tg_id }}";
    const qs = new URLSearchParams({
      referrer_tg_id,
      referred_tg_id,
      tg_id: ADMIN_TG_ID
    }).toString();

    const res = await fetch(
      `/api/referrals/one?${qs}`, 
      {
        method: 'DELETE',
        headers: { 'X-Token': TOKEN }
      }
    );

    if (res.ok) {
      location.reload();
    } else {
      const err = await res.json().catch(()=>({}));
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞: ' + (err.detail||err.error||res.status));
    }
  }
</script>
{% endblock %}