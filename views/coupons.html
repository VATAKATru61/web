{% extends "base.html" %}

{% block title %}–ö—É–ø–æ–Ω—ã | FAST VPN{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/coupons.css">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>
        <i class="fas fa-ticket-alt"></i>
        –ö—É–ø–æ–Ω—ã
    </h1>
    <p class="page-subtitle">–í—Å–µ–≥–æ: {{ total_coupons }}</p>
</div>
{% endblock %}

{% block content %}
<div class="table-container">
    <div class="search-container">
        <input type="text" id="couponSearchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏–ª–∏ —Å–∫–∏–¥–∫–µ..." />
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="openCreateModal()" class="btn btn-sm btn-success">–°–æ–∑–¥–∞—Ç—å –∫—É–ø–æ–Ω</button>
            <button class="btn btn-sm btn-danger" id="delete-selected-coupons">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all-coupons"></th>
                <th>ID</th>
                <th>–ö—É–ø–æ–Ω</th>
                <th>–°—É–º–º–∞/–î–Ω–µ–π</th>
                <th>–õ–∏–º–∏—Ç</th>
                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for coupon in coupons %}
            <tr>
                <td><input type="checkbox" class="coupon-select" data-coupon-code="{{ coupon.code }}"></td>
                <td>{{ coupon.id }}</td>
                <td>{{ coupon.code }}</td>
                <td>
                    {% if coupon.amount %}
                        {{ coupon.amount }}
                    {% else %}
                        {{ coupon.days }}
                    {% endif %}
                </td>
                <td>{{ coupon.usage_limit }}</td>
                <td>{{ coupon.used_count }}</td>
                <td class="table-cell-actions">
                    <button onclick='openEditModal(JSON.parse(this.dataset.coupon))' data-coupon='{{ coupon | tojson | safe }}' class="btn-edit">
                        <i class="fas fa-edit"></i>
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button onclick='openDeleteModal("{{ coupon.code }}")' class="btn-delete">
                        <i class="fas fa-trash"></i>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal" id="createModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–°–æ–∑–¥–∞—Ç—å –∫—É–ø–æ–Ω</h2>
            <button class="close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createCouponForm">
                <div class="form-group">
                    <label>–ö–æ–¥ –∫—É–ø–æ–Ω–∞:</label>
                    <input type="text" id="create-code" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø –∫—É–ø–æ–Ω–∞:</label>
                    <select id="create-type" class="form-control">
                        <option value="amount">–°—É–º–º–∞</option>
                        <option value="days">–î–Ω–µ–π</option>
                    </select>
                </div>
                <div class="form-group" id="create-amount-group">
                    <label>–°—É–º–º–∞ (‚ÇΩ):</label>
                    <input type="number" id="create-amount" class="form-control" min="0" step="0.01">
                </div>
                <div class="form-group" id="create-days-group" style="display:none;">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</label>
                    <input type="number" id="create-days" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label>–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:</label>
                    <input type="number" id="create-usage_limit" class="form-control" min="1" value="1">
                </div>
                <div class="form-group" style="display: none;">
                    <label>–°—Å—ã–ª–∫–∞:</label>
                    <input type="text" id="create-link" class="form-control">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        –°–æ–∑–¥–∞—Ç—å
                    </button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω</h2>
            <button class="close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editCouponForm">
                <input type="hidden" id="edit-original_code">
                <input type="hidden" id="edit-id">

                <div class="form-group">
                    <label>–ö–æ–¥ –∫—É–ø–æ–Ω–∞:</label>
                    <input type="text" id="edit-code" class="form-control">
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø –∫—É–ø–æ–Ω–∞:</label>
                    <select id="edit-type" class="form-control">
                        <option value="amount">–°—É–º–º–∞</option>
                        <option value="days">–î–Ω–µ–π</option>
                    </select>
                </div>
                <div class="form-group" id="edit-amount-group">
                    <label>–°—É–º–º–∞ (‚ÇΩ):</label>
                    <input type="number" id="edit-amount" class="form-control" min="0" step="0.01">
                </div>
                <div class="form-group" id="edit-days-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</label>
                    <input type="number" id="edit-days" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label>–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:</label>
                    <input type="number" id="edit-usage_limit" class="form-control" min="1">
                </div>
                <div class="form-group">
                    <label>–°—Å—ã–ª–∫–∞:</label>
                    <input type="text" id="edit-link" class="form-control">
                </div>

                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
            <button class="close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫—É–ø–æ–Ω <strong><span id="delete-coupon-id"></span></strong>?</p>
            <p class="text-muted">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        </div>
        <div class="modal-footer">
            <button onclick="confirmDelete()" class="btn btn-danger">
                <i class="fas fa-trash"></i>
                –î–∞, —É–¥–∞–ª–∏—Ç—å
            </button>
            <button onclick="closeDeleteModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
</div>

<script>
    const TG_ID = "{{ tg_id }}";
    const TOKEN = "{{ token }}";

    // Create
    function openCreateModal() { document.getElementById('createModal').style.display = 'flex'; }
    function closeCreateModal() { document.getElementById('createModal').style.display = 'none'; }
    document.getElementById('create-type').addEventListener('change', function() {
        const t = this.value;
        document.getElementById('create-amount-group').style.display = t==='amount' ? 'block':'none';
        document.getElementById('create-days-group').style.display = t==='days' ? 'block':'none';
    });
    document.getElementById('createCouponForm').addEventListener('submit', async e => {
        e.preventDefault();
        const p = id=>document.getElementById(id).value;
        const payload = { code: p('create-code'), usage_limit: parseInt(p('create-usage_limit'),10), link: p('create-link') };
        if (p('create-type')==='amount') payload.amount=parseFloat(p('create-amount'));
        else payload.days=parseInt(p('create-days'),10);
        const res=await fetch(`/coupons?tg_id=${TG_ID}`,{ method:'POST', headers:{'Content-Type':'application/json','X-Token':TOKEN}, body:JSON.stringify(payload) });
        res.ok?location.reload():alert(`‚ùå ${(await res.json()).error}`);
    });

    let selectedCouponCode=null;
    function openEditModal(coupon){
        selectedCouponCode=coupon.code;
        document.getElementById('edit-original_code').value=coupon.code;
        document.getElementById('edit-id').value=coupon.id;
        document.getElementById('edit-code').value=coupon.code;
        document.getElementById('edit-usage_limit').value=coupon.usage_limit;
        document.getElementById('edit-link').value=coupon.link;
        document.getElementById('edit-type').value=coupon.amount? 'amount':'days';
        document.getElementById('edit-amount-group').style.display=coupon.amount? 'block':'none';
        document.getElementById('edit-days-group').style.display=coupon.days? 'block':'none';
        document.getElementById('edit-amount').value=coupon.amount||'';
        document.getElementById('edit-days').value=coupon.days||'';
        document.getElementById('editModal').style.display='flex';
    }
    function closeEditModal(){ document.getElementById('editModal').style.display='none'; }
    document.getElementById('edit-type').addEventListener('change', function(){
        const t=this.value;
        document.getElementById('edit-amount-group').style.display=t==='amount'?'block':'none';
        document.getElementById('edit-days-group').style.display=t==='days'?'block':'none';
    });
    document.getElementById('editCouponForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const p=id=>document.getElementById(id).value;
        const payload={ code:p('edit-code'), usage_limit:parseInt(p('edit-usage_limit'),10), link:p('edit-link') };
        if(p('edit-type')==='amount') payload.amount=parseFloat(p('edit-amount'));
        else payload.days=parseInt(p('edit-days'),10);
        const res=await fetch(`/coupons/${encodeURIComponent(selectedCouponCode)}?tg_id=${TG_ID}`,{ method:'PATCH', headers:{'Content-Type':'application/json','X-Token':TOKEN}, body:JSON.stringify(payload) });
        res.ok?location.reload():alert(`‚ùå ${(await res.json()).error}`);
    });

    function openDeleteModal(code){ selectedCouponCode=code; document.getElementById('delete-coupon-id').textContent=code; document.getElementById('deleteModal').style.display='flex'; }
    function closeDeleteModal(){ document.getElementById('deleteModal').style.display='none'; }
    async function confirmDelete(){ const res=await fetch(`/coupons/${encodeURIComponent(selectedCouponCode)}?tg_id=${TG_ID}`,{ method:'DELETE', headers:{'X-Token':TOKEN} }); res.ok?location.reload():alert(`‚ùå ${(await res.json()).error}`); }

    document.getElementById('delete-selected-coupons').addEventListener('click', async () => {
        const selectedCoupons = Array.from(document.querySelectorAll('.coupon-select:checked')).map(cb => cb.dataset.couponCode);
        if (selectedCoupons.length === 0) return alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫—É–ø–æ–Ω');
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedCoupons.length} –∫—É–ø–æ–Ω–æ–≤?`)) return;
        let success = true;
        for (const couponCode of selectedCoupons) {
            const res = await fetch(`/coupons/${encodeURIComponent(couponCode)}?tg_id=${TG_ID}`, {
                method: 'DELETE',
                headers: { 'X-Token': TOKEN }
            });
            if (!res.ok) {
                success = false;
                break;
            }
        }
        success ? location.reload() : alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –∫—É–ø–æ–Ω–æ–≤');
    });

    document.getElementById('couponSearchInput').addEventListener('input',function(){ const f=this.value.toLowerCase(); document.querySelectorAll('.data-table tbody tr').forEach(r=>{ r.style.display=Array.from(r.cells).some(td=>td.textContent.toLowerCase().includes(f))?'':'none'; }); });
    document.getElementById('select-all-coupons').addEventListener('change', function() {
        const checked = this.checked;
        document.querySelectorAll('.coupon-select').forEach(cb => cb.checked = checked);
    });
</script>
{% endblock %}