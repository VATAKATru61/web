{% extends "base.html" %}
{% block title %}–†–µ—Ñ–µ—Ä–∞–ª—ã | FAST VPN{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="/static/css/table.css">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>
        <i class="fas fa-user-friends"></i>
        –†–µ—Ñ–µ—Ä–∞–ª—ã
    </h1>
    <p class="page-subtitle">–í—Å–µ–≥–æ: {{ referrals|length }}</p>
</div>
{% endblock %}

{% block content %}
<div class="table-container">
    <div class="search-container">
        <input type="text" id="referralSearchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—é –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–º—É...">
        <button class="btn btn-sm btn-danger" id="delete-selected-referrals">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>
    <table class="data-table" id="referralsTable">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all-referrals"></th>
                <th>ID</th>
                <th>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å (referrer)</th>
                <th>–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π (referral)</th>
                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                <th>–ë–æ–Ω—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for r in referrals %}
            <tr>
                <td><input type="checkbox" class="referral-checkbox" value="{{ r.referrer_tg_id }}:{{ r.referred_tg_id }}"></td>
                <td>{{ r.id }}</td>
                <td><a href="/users/{{ r.referrer_tg_id }}" class="link">{{ r.referrer_tg_id }}</a></td>
                <td><a href="/users/{{ r.referred_tg_id }}" class="link">{{ r.referred_tg_id }}</a></td>
                <td>{{ r.created_at or '‚Äî' }}</td>
                <td>
                  {% if r.reward_issued is defined %}
                    {{ '–î–∞' if r.reward_issued else '–ù–µ—Ç' }}
                  {% else %}
                    {{ r.bonus or '‚Äî' }}
                  {% endif %}
                </td>
                <td class="table-cell-actions">
                    <button class="btn-delete" onclick="deleteReferral('{{ r.referrer_tg_id }}', '{{ r.referred_tg_id }}')">
                        <i class="fas fa-trash"></i>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
document.getElementById('referralSearchInput').addEventListener('input', function() {
  const q = this.value.toLowerCase();
  document.querySelectorAll('#referralsTable tbody tr').forEach(row => {
    const cells = Array.from(row.cells);
    row.style.display = cells.some(td => td.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
});

async function deleteReferral(referrer_tg_id, referred_tg_id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞?')) return;
  const res = await fetch(`/referrals/one?referrer_tg_id=${referrer_tg_id}&referred_tg_id=${referred_tg_id}&tg_id={{ tg_id }}`, {
    method: "DELETE",
    headers: {
      "X-Token": "{{ token }}"
    }
  });
  if (res.ok) {
    location.reload();
  } else {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞");
  }
}

document.getElementById('select-all-referrals').addEventListener('change', function() {
  const checked = this.checked;
  document.querySelectorAll('.referral-checkbox').forEach(cb => cb.checked = checked);
});

document.getElementById('delete-selected-referrals').addEventListener('click', async function() {
  const selected = Array.from(document.querySelectorAll('.referral-checkbox:checked')).map(cb => cb.value);
  if (selected.length === 0) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–∞–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
    return;
  }
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã (${selected.length} —à—Ç.)?`)) return;
  let success = true;
  for (const val of selected) {
    const [referrer_tg_id, referred_tg_id] = val.split(':');
    const res = await fetch(`/referrals/one?referrer_tg_id=${referrer_tg_id}&referred_tg_id=${referred_tg_id}&tg_id={{ tg_id }}`, {
      method: "DELETE",
      headers: {
        "X-Token": "{{ token }}"
      }
    });
    if (!res.ok) {
      success = false;
      break;
    }
  }
  if (success) location.reload();
  else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤");
});
</script>
{% endblock %}