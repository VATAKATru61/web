{% extends "base.html" %}
{% block title %}–ü–æ–¥–∞—Ä–∫–∏ | FAST VPN{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="/static/css/table.css">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>
        <i class="fas fa-gift"></i>
        –ü–æ–¥–∞—Ä–∫–∏
    </h1>
    <p class="page-subtitle">–í—Å–µ–≥–æ: {{ gifts|length }}</p>
</div>
{% endblock %}

{% block content %}
<div class="table-container">
    <div class="search-container">
        <input type="text" id="giftSearchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID, –ø–æ–ª—É—á–∞—Ç–µ–ª—é, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é..." />
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-success" onclick="openCreateModal()">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
            <button class="btn btn-sm btn-danger" id="delete-selected-gifts">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>
    <table class="data-table" id="giftsTable">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all-gifts"></th>
                <th>ID –ø–æ–¥–∞—Ä–∫–∞</th>
                <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                <th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                <th>–ú–µ—Å—è—Ü—ã</th>
                <th>–¢–∞—Ä–∏—Ñ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for g in gifts %}
            <tr>
                <td><input type="checkbox" class="gift-checkbox" value="{{ g.gift_id }}"></td>
                <td>{{ g.gift_id }}</td>
                <td>{{ g.sender_tg_id }}</td>
                <td>{{ g.recipient_tg_id }}</td>
                <td>{{ g.created_at_human }}</td>
                <td>{{ g.selected_months or '‚Äî' }}</td>
                <td>
                  {% set tariff = tariffs | selectattr('id', 'equalto', g.tariff_id | int) | first %}
                  {{ tariff.name if tariff else g.tariff_id or '‚Äî' }}
                </td>
                <td>
                  {% if g.is_used %}
                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
                  {% elif g.is_unlimited %}
                    –ë–µ–∑–ª–∏–º–∏—Ç
                  {% else %}
                    –ê–∫—Ç–∏–≤–µ–Ω
                  {% endif %}
                </td>
                <td>
                                      <button class="btn-edit" data-gift='{{ g|tojson|safe }}' onclick="openEditModalFromButton(this)">
                        <i class="fas fa-edit"></i>
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button onclick='openDeleteModal("{{ g.gift_id }}")' class="btn-delete">
                        <i class="fas fa-trash"></i>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h2>
      <button class="close" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="editGiftForm">
        <input type="hidden" id="edit-gift_id">
        <div class="form-group">
          <label>ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:</label>
          <input type="text" id="edit-sender_tg_id" class="form-control">
        </div>
        <div class="form-group">
          <label>ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
          <input type="text" id="edit-recipient_tg_id" class="form-control">
        </div>
        <div class="form-group">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤:</label>
          <input type="number" id="edit-selected_months" class="form-control" min="0">
        </div>
        <div class="form-group">
          <label>–¢–∞—Ä–∏—Ñ:</label>
          <select id="edit-tariff_id" class="form-control" required>
            {% for t in tariffs %}
              <option value="{{ t.id }}">{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
          <input type="text" id="edit-comment" class="form-control">
        </div>
        <div class="form-group">
          <label>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π:</label>
          <select id="edit-is_unlimited" class="form-control">
            <option value="false">–ù–µ—Ç</option>
            <option value="true">–î–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω:</label>
          <select id="edit-is_used" class="form-control">
            <option value="false">–ù–µ—Ç</option>
            <option value="true">–î–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:</label>
          <input type="number" id="edit-max_usages" class="form-control" min="0">
        </div>
        <div class="form-group">
          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫:</label>
          <input type="text" id="edit-gift_link" class="form-control">
        </div>
        <div class="form-group">
          <label>–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è:</label>
          <input type="text" id="edit-expiry_time" class="form-control" placeholder="YYYY-MM-DD HH:MM:SS">
        </div>
        <div class="form-buttons">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          <button type="button" onclick="closeEditModal()" class="btn btn-secondary">
            <i class="fas fa-times"></i>
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
      <button class="close" onclick="closeDeleteModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ —Å ID <strong><span id="delete-gift-id"></span></strong>?</p>
      <p class="text-muted">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
    </div>
    <div class="modal-footer">
      <button onclick="confirmDelete()" class="btn btn-danger">
        <i class="fas fa-trash"></i>
        –î–∞, —É–¥–∞–ª–∏—Ç—å
      </button>
      <button onclick="closeDeleteModal()" class="btn btn-secondary">
        <i class="fas fa-times"></i>
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </div>
</div>

<div class="modal" id="createModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h2>
      <button class="close" onclick="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="createGiftForm">
        <input type="hidden" id="create-sender_tg_id" value="{{ tg_id }}">
        <div class="form-group">
          <label>ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
          <input type="text" id="create-recipient_tg_id" class="form-control">
        </div>
        <div class="form-group" style="display: none;">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤:</label>
          <input type="number" id="create-selected_months" class="form-control" min="0" value="0" required>
        </div>
        <div class="form-group">
          <label>–¢–∞—Ä–∏—Ñ:</label>
          <select id="create-tariff_id" class="form-control" required>
            {% for t in tariffs %}
              <option value="{{ t.id }}">{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:</label>
          <input type="number" id="create-max_usages" class="form-control" min="0" value="0">
        </div>
        <div class="form-group" style="display: none;">
          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫:</label>
          <input type="text" id="create-gift_link" class="form-control">
        </div>
        <div class="form-group" style="display: none;">
          <label>–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è:</label>
          <input type="datetime-local" id="create-expiry_time" class="form-control">
        </div>
        <div class="form-group">
          <label>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π:</label>
          <select id="create-is_unlimited" class="form-control">
            <option value="false">–ù–µ—Ç</option>
            <option value="true">–î–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω:</label>
          <select id="create-is_used" class="form-control">
            <option value="false">–ù–µ—Ç</option>
            <option value="true">–î–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
          <input type="number" id="create-count" class="form-control" min="1" value="1" required>
        </div>
        <div class="form-buttons">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            –°–æ–∑–¥–∞—Ç—å
          </button>
          <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">
            <i class="fas fa-times"></i>
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const TOKEN = "{{ token or '' }}";
const TG_ID = "{{ tg_id or '0' }}";
let selectedGift = null;

document.getElementById('giftSearchInput').addEventListener('input', function() {
  const q = this.value.toLowerCase();
  document.querySelectorAll('#giftsTable tbody tr').forEach(row => {
    const cells = Array.from(row.cells);
    row.style.display = cells.some(td => td.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
});

function openEditModal(gift) {
  selectedGift = gift;
  document.getElementById('edit-gift_id').value = gift.gift_id;
  document.getElementById('edit-sender_tg_id').value = gift.sender_tg_id || '';
  document.getElementById('edit-recipient_tg_id').value = gift.recipient_tg_id || '';
  document.getElementById('edit-selected_months').value = gift.selected_months || '';
  document.getElementById('edit-tariff_id').value = gift.tariff_id || '';
  document.getElementById('edit-comment').value = gift.comment || '';
  document.getElementById('edit-is_unlimited').value = gift.is_unlimited ? 'true' : 'false';
  document.getElementById('edit-is_used').value = gift.is_used ? 'true' : 'false';
  document.getElementById('edit-max_usages').value = gift.max_usages || '';
  document.getElementById('edit-gift_link').value = gift.gift_link || '';
  document.getElementById('edit-expiry_time').value = gift.expiry_time || '';
  document.getElementById('editModal').style.display = 'flex';
}
function openEditModalFromButton(btn) {
  const gift = JSON.parse(btn.getAttribute('data-gift'));
  openEditModal(gift);
}
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

document.getElementById('editGiftForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const giftId = document.getElementById('edit-gift_id').value;

  const expiryRaw = document.getElementById('edit-expiry_time').value;
  let expiry_time = null;
  if (expiryRaw) {
    const d = new Date(expiryRaw);
    expiry_time = d.getFullYear() + '-' +
                  String(d.getMonth() + 1).padStart(2, '0') + '-' +
                  String(d.getDate()).padStart(2, '0') + 'T' +
                  String(d.getHours()).padStart(2, '0') + ':' +
                  String(d.getMinutes()).padStart(2, '0') + ':' +
                  String(d.getSeconds()).padStart(2, '0') + '.' +
                  String(d.getMilliseconds()).padStart(3, '0');
  }

  const payload = {
    recipient_tg_id: document.getElementById('edit-recipient_tg_id').value ? parseInt(document.getElementById('edit-recipient_tg_id').value, 10) : null,
    selected_months: document.getElementById('edit-selected_months').value ? parseInt(document.getElementById('edit-selected_months').value, 10) : null,
    expiry_time: expiry_time,
    gift_link: document.getElementById('edit-gift_link').value || null,
    is_used: document.getElementById('edit-is_used').value === 'true',
    is_unlimited: document.getElementById('edit-is_unlimited').value === 'true',
    max_usages: document.getElementById('edit-max_usages').value ? parseInt(document.getElementById('edit-max_usages').value, 10) : null,
    tariff_id: document.getElementById('edit-tariff_id').value ? parseInt(document.getElementById('edit-tariff_id').value, 10) : null
  };

  const res = await fetch(`/gifts/${encodeURIComponent(giftId)}?tg_id=${TG_ID}`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-Token': TOKEN
    },
    body: JSON.stringify(payload)
  });
  if (res.ok) location.reload();
  else alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞');
});

function openDeleteModal(giftId) {
  document.getElementById('delete-gift-id').innerText = giftId;
  selectedGift = giftId;
  document.getElementById('deleteModal').style.display = 'flex';
}
function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}
async function confirmDelete() {
  const res = await fetch(`/gifts/${encodeURIComponent(selectedGift)}?tg_id=${TG_ID}`, {
    method: 'DELETE',
    headers: { 'X-Token': TOKEN }
  });
  if (res.ok) location.reload();
  else alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞');
}

function openCreateModal() {
  document.getElementById('createGiftForm').reset();
  document.getElementById('createModal').style.display = 'flex';
}
function closeCreateModal() {
  document.getElementById('createModal').style.display = 'none';
}

document.getElementById('createGiftForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  let expiry_time = document.getElementById('create-expiry_time').value;
  expiry_time = expiry_time ? new Date(expiry_time).toISOString() : undefined;

  const recipient = document.getElementById('create-recipient_tg_id').value;
  const count = parseInt(document.getElementById('create-count').value, 10) || 1;

  const payload = {
    sender_tg_id: TG_ID,
    selected_months: parseInt(document.getElementById('create-selected_months').value, 10),
    tariff_id: parseInt(document.getElementById('create-tariff_id').value, 10),
    max_usages: parseInt(document.getElementById('create-max_usages').value, 10) || 0,
    gift_link: document.getElementById('create-gift_link').value || "",
    is_used: document.getElementById('create-is_used').value === 'true',
    is_unlimited: document.getElementById('create-is_unlimited').value === 'true'
  };
  if (expiry_time) payload.expiry_time = expiry_time;
  if (recipient) payload.recipient_tg_id = parseInt(recipient, 10);

  let success = true;
  for (let i = 0; i < count; i++) {
    const res = await fetch(`/gifts?tg_id=${TG_ID}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Token': TOKEN
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      success = false;
      break;
    }
  }
  if (success) location.reload();
  else alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞');
});

document.getElementById('select-all-gifts').addEventListener('change', function() {
  const checked = this.checked;
  document.querySelectorAll('.gift-checkbox').forEach(cb => cb.checked = checked);
});

document.getElementById('delete-selected-gifts').addEventListener('click', async function() {
  const selected = Array.from(document.querySelectorAll('.gift-checkbox:checked')).map(cb => cb.value);
  if (selected.length === 0) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
    return;
  }
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ (${selected.length} —à—Ç.)?`)) return;
  let success = true;
  for (const giftId of selected) {
    const res = await fetch(`/gifts/${encodeURIComponent(giftId)}?tg_id=${TG_ID}`, {
      method: 'DELETE',
      headers: { 'X-Token': TOKEN }
    });
    if (!res.ok) {
      success = false;
      break;
    }
  }
  if (success) location.reload();
  else alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏');
});
</script>
{% endblock %}